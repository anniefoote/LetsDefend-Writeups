# Writeup: SOC175 - PowerShell Found in Requested URL - Possible CVE-2022-41082 Exploitation

## Basic Info
**Category:** SOC Analyst\
**Rating:** High\
**Type:** Web Attack\
**Event ID:** 175

<img width="1566" alt="Screenshot 2023-11-29 at 10 23 02 AM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/2fddf055-0235-4780-a928-45a44a8fe46a">

## Playbook

### Understand Why the Alert Was Triggered
The alert was triggered as the requested URL contained the keyword "PowerShell" in it, indicating an attacker may be trying to execute malicious commands. The requested URL was: `/autodiscover/autodiscover.json?@evil.com/owa/&Email=autodiscover/autodiscover.json%3f@evil.com&Protocol=XYZ&FooProtocol=Powershell`

Traffic in the alert originated from an external ip, 58.237.200.6, travelling to the network Exchange Server 2 hosted at 172.16.20.8. Traffice is sent via HTTP as a GET request.

#### Playbook Action: None

### Collect Data
Traffic Source: External IP - 58.237.200.6

Looking up the IP in VirusTotal shows it is located in South Korea and has been flagged as malicious. The IP is owned by a telecommunications company.
<img width="1608" alt="Screenshot 2023-11-29 at 11 15 03 AM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/41ff6e5d-20f7-4d7b-84db-417df6e5c6e2">
Looking up the IP in AbuseIPDB shows it has been reported 612 times but has a confidence of abuse of 0%. This doesn't necessarily indicate the IP is guaranteed to be non-malicious as the confidence of abuse is based partly on when the reports were made. As the logs were from September 2022 and my analysis is taking place November 2023, the IP may no longer be marked as malicious if it is no longer used in malicious acitivty.

#### Playbook Action: None

### Examine HTTP Traffic
Logs show 3 requests being made from the IP to the Exchange Server.
<img width="1502" alt="Screenshot 2023-11-29 at 11 30 29 AM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/6680a629-c0c2-4abf-a0d1-ba6cd6241ff3">
The first request appears to be the attacker assessing whether an attack may be possible while the other two appear to be the attacker trying to exploit the vulnerability in the server.
<img width="1473" alt="Screenshot 2023-11-29 at 11 34 15 AM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/489ace55-fb96-4f87-9246-b6bd26ba5467">
<img width="1478" alt="Screenshot 2023-11-29 at 11 33 52 AM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/dc2c8c6f-5c96-4cae-b24c-a9a9da2ef4e2">
All three of the requests show as being blocked.

#### Playbook Action: None

### Is Traffic Malicious?
Looking at the requested URLs in the two malicious requests, we can see they follow the same format as the ProxyNotShell vulnerability. The vulnerability targets a vulnerability in Exchange servers allowing remote code execution to be implemented.
<img width="1050" alt="Screenshot 2023-11-29 at 12 14 17 PM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/ad2fd2e6-dc1a-467f-8fff-059fcb93a539">
As the request URLs match those observed in documentation around the ProxyNotShell vulnerability and CVE-2022-41082, it is likely this traffic is malicious.

#### Playbook Action: Is the traffic malicious? Yes (Malicious)

### Attack Type
The ProxyNotShell vulnerability (CVE-2022-41082) achieves remote code execution when executed successfully as a result of Exchange PowerShell being accessible to the attacker. As the URL in the malicious requests is targeting PowerShell, we can confirm it is trying to exploit CVE-2022-41082. As such the attack type will be remote code execution.
<img width="954" alt="Screenshot 2023-11-29 at 12 35 57 PM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/68e69247-195f-4991-a6c8-9c33178ac7c9"> <br />

More information about CVE-2022-41082: https://unit42.paloaltonetworks.com/proxynotshell-cve-2022-41040-cve-2022-41082/ 
#### Playbook Action: What is the traffic type? Other (Remote Code Execution)

### Check for Planned Test
Searching the attacker's IP in email logs doesn't produce any results. This means it doesn't appear that the attack is part of a planned test.
<img width="1057" alt="Screenshot 2023-11-29 at 12 37 51 PM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/723c65bb-e03e-47b0-a568-9ed6357d26b0">
Looking at email logs of planned tests doesn't produce any results indicating this behaviour is part of testing. As such we can confirm the malicious activity wasn't planned.

#### Playbook Action: Is the malicious traffic caused by a planned test? No (Not Planned)

### Traffic Direction
Based on earlier analysis, we know the traffic is an external IP trying to access the company network. As such the traffic direction is Internet -> Company Network

#### Playbook Action: What is the direction of the traffic? Internet -> Company Network

### Was the Attack Successful?
Traffic logs show all three requests from 58.237.200.6 were blocked. This shows the attack was unsuccessful.
<img width="1180" alt="Screenshot 2023-11-29 at 12 46 00 PM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/215a61e2-0829-4799-9276-c4c886c07b2f">
<img width="1180" alt="Screenshot 2023-11-29 at 12 45 11 PM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/4507f155-9f92-4891-9899-5087775f7d46">
<img width="1182" alt="Screenshot 2023-11-29 at 12 45 38 PM" src="https://github.com/anniefoote/LetsDefend-Writeups/assets/84354375/71366aef-e76b-46fc-b3c8-82b3e621a4e1">

#### Playbook Action: Was the attack successful? No 

### Tier 2 Escalation
Tier 2 escalation is not required as the attack was unsuccessful. 

#### Playbook Action: Perfom tier 2 escalation? No
